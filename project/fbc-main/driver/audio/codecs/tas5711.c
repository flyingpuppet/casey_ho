#include <register.h>
#include <c_arc_pointer_reg.h>
#include <log.h>
#include <i2c.h>
#include <XYmemoryMapping.h>

#include "../audio_control.h"
#include "tas5711.h"

static char TAG[] = "tas5711";

extern void sleep(int us);

struct tas5711_parameters customer_parameter = {
	.DRC1_enable = 0,
	.DRC2_enable = 0,
	.Subwoofer_BQ_enable = 0,
	.EQ_enable = 0,
};
static unsigned char TAS5711_drc1_table[3][8]={
	//0x3A   drc1_ae
	{0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
	//0x3B   drc1_aa
	{0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
	//0x3C   drc1_ad
	{0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00}
};
static unsigned char tas5711_drc1_tko_table[3][4]={
	//0x40   drc1_t
	{0x00,0x00,0x00,0x00},
	//0x41   drc1_k
	{0x00,0x00,0x00,0x00},
	//0x42   drc1_o
	{0x00,0x00,0x00,0x00}
};
static unsigned char TAS5711_drc2_table[3][8]={
	//0x3D   drc2_ae
	{0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
	//0x3E   drc2_aa
	{0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
	//0x3F   drc2_ad
	{0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00}
};
static unsigned char tas5711_drc2_tko_table[3][4]={
	//0x43   drc2_t
	{0x00,0x00,0x00,0x00},
	//0x44   drc2_k
	{0x00,0x00,0x00,0x00},
	//0x45   drc2_o
	{0x00,0x00,0x00,0x00}
};
static unsigned char TAS5711_subwoofer_table[2][20]={
	//0x5A   150Hz-lowpass
	{0x00,0x00,0x03,0x1D,
	 0x00,0x00,0x06,0x3A,
	 0x00,0x00,0x03,0x1D,
	 0x00,0xFC,0x72,0x05,
	 0x0F,0x83,0x81,0x85},
	//0x5B   150HZ-10dB
	{0x00,0x81,0x50,0x89,
	 0x0F,0x03,0x68,0x8C,
	 0x00,0x7B,0x6A,0x2F,
	 0x00,0xFC,0xA3,0x83,
	 0x0F,0x83,0x51,0x56}
};
static unsigned char tas5711_eq_table[2][18][20]={
{
	//TABLE
	{0x00, 0x7E, 0x95, 0xFF, 0x0F, 0x02, 0xD4, 0x01, 0x00, 0x7E,
	0x95, 0xFF, 0x00, 0xFD, 0x27, 0xFF, 0x0F, 0x82, 0xD0, 0x01}, /*0x29---ch1_bq[0]*/
	{0x00, 0x7F, 0x83, 0xD8, 0x0F, 0x02, 0xC3, 0x92, 0x00, 0x7D,
	0xDB, 0x4F, 0x00, 0xFD, 0x3C, 0x6E, 0x0F, 0x82, 0xA0, 0xD8}, /*0x2A---ch1_bq[1]*/
	{0x00, 0x82, 0xCE, 0x97, 0x0F, 0x4C, 0x87, 0x81, 0x00, 0x5F,
	0x69, 0x2D, 0x00, 0xB3, 0x78, 0x7F, 0x0F, 0x9D, 0xC8, 0x3B}, /*0x2B---ch1_bq[2]*/
	{0x00, 0x83, 0x6B, 0x4A, 0x0F, 0x7A, 0x3D, 0xA6, 0x00, 0x58,
	0x4D, 0xED, 0x00, 0x85, 0xC2, 0x5A, 0x0F, 0xA4, 0x46, 0xC9}, /*0x2C---ch1_bq[3]*/
	{0x00, 0x83, 0x6B, 0x4A, 0x0F, 0xAB, 0xEA, 0x5C, 0x00, 0x58,
	0x4D, 0xED, 0x00, 0x54, 0x15, 0xA4, 0x0F, 0xA4, 0x46, 0xC9}, /*0x2D---ch1_bq[4]*/
	{0x00, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, /*0x2E---ch1_bq[5]*/
	{0x00, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, /*0x2F---ch1_bq[6]*/
	{0x00, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, /*0x58---ch1_bq[7]*/
	{0x00, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, /*0x59---ch1_bq[8]*/
	{0x00, 0x7E, 0x95, 0xFF, 0x0F, 0x02, 0xD4, 0x01, 0x00, 0x7E,
	0x95, 0xFF, 0x00, 0xFD, 0x27, 0xFF, 0x0F, 0x82, 0xD0, 0x01}, /*0x30---ch2_bq[0]*/
	{0x00, 0x7F, 0x83, 0xD8, 0x0F, 0x02, 0xC3, 0x92, 0x00, 0x7D,
	0xDB, 0x4F, 0x00, 0xFD, 0x3C, 0x6E, 0x0F, 0x82, 0xA0, 0xD8}, /*0x31---ch2_bq[1]*/
	{0x00, 0x82, 0xCE, 0x97, 0x0F, 0x4C, 0x87, 0x81, 0x00, 0x5F,
	0x69, 0x2D, 0x00, 0xB3, 0x78, 0x7F, 0x0F, 0x9D, 0xC8, 0x3B}, /*0x32---ch2_bq[2]*/
	{0x00, 0x83, 0x6B, 0x4A, 0x0F, 0x7A, 0x3D, 0xA6, 0x00, 0x58,
	0x4D, 0xED, 0x00, 0x85, 0xC2, 0x5A, 0x0F, 0xA4, 0x46, 0xC9}, /*0x33---ch2_bq[3]*/
	{0x00, 0x83, 0x6B, 0x4A, 0x0F, 0xAB, 0xEA, 0x5C, 0x00, 0x58,
	0x4D, 0xED, 0x00, 0x54, 0x15, 0xA4, 0x0F, 0xA4, 0x46, 0xC9}, /*0x34---ch2_bq[4]*/
	{0x00, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, /*0x35---ch2_bq[5]*/
	{0x00, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, /*0x36---ch2_bq[6]*/
	{0x00, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, /*0x5C---ch2_bq[7]*/
	{0x00, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, /*0x5D---ch2_bq[8]*/
},
{
	//WALL
	{0x00, 0x7E, 0x95, 0xFF, 0x0F, 0x02, 0xD4, 0x01, 0x00, 0x7E,
	0x95, 0xFF, 0x00, 0xFD, 0x27, 0xFF, 0x0F, 0x82, 0xD0, 0x01}, /*0x29---ch1_bq[0]*/
	{0x00, 0x7F, 0x83, 0xD8, 0x0F, 0x02, 0xC3, 0x92, 0x00, 0x7D,
	0xDB, 0x4F, 0x00, 0xFD, 0x3C, 0x6E, 0x0F, 0x82, 0xA0, 0xD8}, /*0x2A---ch1_bq[1]*/
	{0x00, 0x82, 0xCE, 0x97, 0x0F, 0x4C, 0x87, 0x81, 0x00, 0x5F,
	0x69, 0x2D, 0x00, 0xB3, 0x78, 0x7F, 0x0F, 0x9D, 0xC8, 0x3B}, /*0x2B---ch1_bq[2]*/
	{0x00, 0x83, 0x6B, 0x4A, 0x0F, 0x7A, 0x3D, 0xA6, 0x00, 0x58,
	0x4D, 0xED, 0x00, 0x85, 0xC2, 0x5A, 0x0F, 0xA4, 0x46, 0xC9}, /*0x2C---ch1_bq[3]*/
	{0x00, 0x83, 0x6B, 0x4A, 0x0F, 0xAB, 0xEA, 0x5C, 0x00, 0x58,
	0x4D, 0xED, 0x00, 0x54, 0x15, 0xA4, 0x0F, 0xA4, 0x46, 0xC9}, /*0x2D---ch1_bq[4]*/
	{0x00, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, /*0x2E---ch1_bq[5]*/
	{0x00, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, /*0x2F---ch1_bq[6]*/
	{0x00, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, /*0x58---ch1_bq[7]*/
	{0x00, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, /*0x59---ch1_bq[8]*/
	{0x00, 0x7E, 0x95, 0xFF, 0x0F, 0x02, 0xD4, 0x01, 0x00, 0x7E,
	0x95, 0xFF, 0x00, 0xFD, 0x27, 0xFF, 0x0F, 0x82, 0xD0, 0x01}, /*0x30---ch2_bq[0]*/
	{0x00, 0x7F, 0x83, 0xD8, 0x0F, 0x02, 0xC3, 0x92, 0x00, 0x7D,
	0xDB, 0x4F, 0x00, 0xFD, 0x3C, 0x6E, 0x0F, 0x82, 0xA0, 0xD8}, /*0x31---ch2_bq[1]*/
	{0x00, 0x82, 0xCE, 0x97, 0x0F, 0x4C, 0x87, 0x81, 0x00, 0x5F,
	0x69, 0x2D, 0x00, 0xB3, 0x78, 0x7F, 0x0F, 0x9D, 0xC8, 0x3B}, /*0x32---ch2_bq[2]*/
	{0x00, 0x83, 0x6B, 0x4A, 0x0F, 0x7A, 0x3D, 0xA6, 0x00, 0x58,
	0x4D, 0xED, 0x00, 0x85, 0xC2, 0x5A, 0x0F, 0xA4, 0x46, 0xC9}, /*0x33---ch2_bq[3]*/
	{0x00, 0x83, 0x6B, 0x4A, 0x0F, 0xAB, 0xEA, 0x5C, 0x00, 0x58,
	0x4D, 0xED, 0x00, 0x54, 0x15, 0xA4, 0x0F, 0xA4, 0x46, 0xC9}, /*0x34---ch2_bq[4]*/
	{0x00, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, /*0x35---ch2_bq[5]*/
	{0x00, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, /*0x36---ch2_bq[6]*/
	{0x00, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, /*0x5C---ch2_bq[7]*/
	{0x00, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, /*0x5D---ch2_bq[8]*/
}
};

static int tas5711_set_master_vol(unsigned char volume){
	int ret = 0;
	LOGI(TAG, "Set tas5711 master volume!\n");
	ret |= codec_write_byte(TAS5707_I2C_ADDR, DDX_MASTER_VOLUME, (0xff - volume));
	if(ret < 0)
		LOGE(TAG, "set audio master volume failed!\n");
	return ret;
}

static int tas5711_set_mute(void){
	int ret = 0;
	LOGI(TAG, "Set tas5711 mute!\n");
	ret |= codec_write_byte(TAS5707_I2C_ADDR, DDX_MASTER_VOLUME, 0xff);
	if(ret < 0)
		LOGE(TAG, "set audio mute failed!\n");
	return ret;
}

static int tas5711_set_channel_vol(unsigned char L_volume,unsigned char R_volume){
	int ret = 0;
	LOGI(TAG, "Set tas5711 channel volume!\n");
	ret |= codec_write_byte(TAS5707_I2C_ADDR, DDX_CHANNEL1_VOL, (0xff - L_volume));
	ret |= codec_write_byte(TAS5707_I2C_ADDR, DDX_CHANNEL2_VOL, (0xff - R_volume));
	if(ret < 0)
		LOGE(TAG, "set audio channel_vol failed!\n");
	return ret;
}

static int tas5711_set_subchannel_vol(unsigned char sub_volume){
	int ret = 0;
	LOGI(TAG, "Set tas5711 sub channel volume!\n");
	ret = codec_write_byte(TAS5707_I2C_ADDR, DDX_CHANNEL3_VOL, (0xff - sub_volume));
	if(ret < 0)
		LOGE(TAG, "set audio sub channel_vol failed!\n");
	return ret;
}

static int tas5711_set_EQ_mode(unsigned char eq_mode){
	int ret = 0;
	LOGI(TAG,"Set tas5711 eq parameters!\n");
	if(eq_mode != 0 && eq_mode != 1){
		LOGE(TAG,"Unkonwn EQ mode!\n");
		return -1;
	}
	unsigned char tas5711_eq_ctl_table[] = {0x00,0x00,0x00,0x00};
	int i = 0,j = 0,addr = 0;
	for(i = 0;i < 2;i++){
		for(j = 0;j < 9;j++){
			if(j < 7)
				addr = (DDX_CH1_BQ_0 + i*7 + j);
			else
				addr = (DDX_CH1_BQ_7 + i*4 + j - 7);
		}
		ret |= codec_write(TAS5707_I2C_ADDR, addr, tas5711_eq_table[eq_mode][j], 20);
	}
	ret |= codec_write(TAS5707_I2C_ADDR, DDX_BANKSWITCH_AND_EQCTL, tas5711_eq_ctl_table, 4);
	if(ret < 0)
		LOGE(TAG, "set audio EQ failed!\n");
	return ret;
}

static int tas5711_set_DRC1(void){
	int ret = 0;
	LOGI(TAG, "Set tas5711 DRC1 parameters!\n");
	unsigned char drc_mask = 0;
	unsigned char tas5711_drc_ctl_table[] = {0x00,0x00,0x00,0x00};
	ret |= codec_read(TAS5707_I2C_ADDR, DDX_DRC_CTL, tas5711_drc_ctl_table, 4);
	drc_mask = tas5711_drc_ctl_table[3];
	drc_mask |= 1;
	tas5711_drc_ctl_table[3] = drc_mask;
	ret |= codec_write(TAS5707_I2C_ADDR, DDX_DRC1_AE, TAS5711_drc1_table[0], 8);
	ret |= codec_write(TAS5707_I2C_ADDR, DDX_DRC1_AA, TAS5711_drc1_table[1], 8);
	ret |= codec_write(TAS5707_I2C_ADDR, DDX_DRC1_AD, TAS5711_drc1_table[2], 8);
	ret |= codec_write(TAS5707_I2C_ADDR, DDX_DRC1_T, tas5711_drc1_tko_table[0], 4);
	ret |= codec_write(TAS5707_I2C_ADDR, DDX_DRC1_K, tas5711_drc1_tko_table[1], 4);
	ret |= codec_write(TAS5707_I2C_ADDR, DDX_DRC1_O, tas5711_drc1_tko_table[2], 4);
	ret |= codec_write(TAS5707_I2C_ADDR, DDX_DRC_CTL, tas5711_drc_ctl_table, 4);
	if(ret < 0)
		LOGE(TAG, "set audio DRC1 failed!\n");
	return ret;
}

static int tas5711_set_DRC2(void){
	int ret = 0;
	LOGI(TAG, "Set tas5711 DRC2 parameters!\n");
	unsigned char drc_mask = 0;
	unsigned char tas5711_drc_ctl_table[] = {0x00,0x00,0x00,0x00};
	ret |= codec_read(TAS5707_I2C_ADDR, DDX_DRC_CTL, tas5711_drc_ctl_table, 4);
	drc_mask = tas5711_drc_ctl_table[3];
	drc_mask |= 2;
	tas5711_drc_ctl_table[3] = drc_mask;
	ret |= codec_write(TAS5707_I2C_ADDR, DDX_DRC2_AE, TAS5711_drc2_table[0], 8);
	ret |= codec_write(TAS5707_I2C_ADDR, DDX_DRC2_AA, TAS5711_drc2_table[1], 8);
	ret |= codec_write(TAS5707_I2C_ADDR, DDX_DRC2_AD, TAS5711_drc2_table[2], 8);
	ret |= codec_write(TAS5707_I2C_ADDR, DDX_DRC2_T, tas5711_drc2_tko_table[0], 4);
	ret |= codec_write(TAS5707_I2C_ADDR, DDX_DRC2_K, tas5711_drc2_tko_table[1], 4);
	ret |= codec_write(TAS5707_I2C_ADDR, DDX_DRC2_O, tas5711_drc2_tko_table[2], 4);
	ret |= codec_write(TAS5707_I2C_ADDR, DDX_DRC_CTL, tas5711_drc_ctl_table, 4);
	if(ret < 0)
		LOGE(TAG, "set audio DRC2 failed!\n");
	return ret;
}

static int tas5711_set_Subwoofer_BQ(void){
	int ret = 0;
	LOGI(TAG, "Set tas5711 Subwoofer_BQ parameters!\n");
	ret |= codec_write(TAS5707_I2C_ADDR, DDX_SUBCHANNEL_BQ_0, TAS5711_subwoofer_table[0], 20);
	ret |= codec_write(TAS5707_I2C_ADDR, DDX_SUBCHANNEL_BQ_1, TAS5711_subwoofer_table[1], 20);
	if(ret < 0)
		LOGE(TAG, "set audio Subwoofer_BQ failed!\n");
	return ret;
}



static int tas5711_init(void){
	int ret = 0;
	unsigned char burst_data[][4]= {
		{0x00,0x01,0x77,0x72},
		{0x00,0x00,0x42,0x03},
		{0x01,0x01,0x32,0x45},
	};

	LOGI(TAG, "tas5711_init\n");
	ret |= codec_write_byte(TAS5707_I2C_ADDR, DDX_OSC_TRIM, 0x00);
	sleep(50*1000); //50ms
	ret |= codec_write_byte(TAS5707_I2C_ADDR, DDX_CLOCK_CTL, 0x6c);//0x74 = 512fs; 0x6c = 256fs 
	ret |= codec_write_byte(TAS5707_I2C_ADDR, DDX_SYS_CTL_1, 0xa0);
	ret |= codec_write_byte(TAS5707_I2C_ADDR, DDX_SERIAL_DATA_INTERFACE, 0x03); //0x03: i2s 16bit, 0x05: i2s 24bit
	ret |= codec_write_byte(TAS5707_I2C_ADDR, DDX_BKND_ERR, 0x02);

	ret |= codec_write(TAS5707_I2C_ADDR, DDX_INPUT_MUX, burst_data[0], 4);
	ret |= codec_write(TAS5707_I2C_ADDR, DDX_CH4_SOURCE_SELECT, burst_data[1], 4);
	ret |= codec_write(TAS5707_I2C_ADDR, DDX_PWM_MUX, burst_data[2], 4);

	
	//drc1
	if(customer_parameter.DRC1_enable == 1){
		ret |= tas5711_set_DRC1();
	}
	//drc2
	if(customer_parameter.DRC2_enable == 1){
		ret |= tas5711_set_DRC2();
	}
	
	//subwoofer
	if(customer_parameter.Subwoofer_BQ_enable == 1){
		ret |= tas5711_set_Subwoofer_BQ();
	}
	
	//eq
	if(customer_parameter.EQ_enable == 1){
		ret |= tas5711_set_EQ_mode(1);
	}

	ret |= codec_write_byte(TAS5707_I2C_ADDR, DDX_VOLUME_CONFIG, 0xD1);
	ret |= codec_write_byte(TAS5707_I2C_ADDR, DDX_SYS_CTL_2, 0x84);
	ret |= codec_write_byte(TAS5707_I2C_ADDR, DDX_START_STOP_PERIOD, 0x95);
	ret |= codec_write_byte(TAS5707_I2C_ADDR, DDX_PWM_SHUTDOWN_GROUP, 0x30);
	ret |= codec_write_byte(TAS5707_I2C_ADDR, DDX_MODULATION_LIMIT, 0x02);

	ret |= tas5711_set_channel_vol(207,207);	//set default channel volume
	ret |= tas5711_set_master_vol(0);			//mater voiume mute
	
	ret |= codec_write_byte(TAS5707_I2C_ADDR, DDX_SOFT_MUTE, 0x00);

	return ret;
}

struct codec_control tas5711 = {
	.init = tas5711_init,
	.set_mute = tas5711_set_mute,
	.set_master_vol = tas5711_set_master_vol,
	.set_channel_vol = tas5711_set_channel_vol,
	.set_subchannel_vol = tas5711_set_subchannel_vol,
	.set_EQ_mode = tas5711_set_EQ_mode,
	.set_user_parameters = NULL,
	.set_fine_volume = NULL,
};

